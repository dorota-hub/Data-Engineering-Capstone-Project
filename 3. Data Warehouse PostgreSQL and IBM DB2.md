# Load data into a staging Data Warehouse on PostgreSQL

Sample data provided by the company:

![ecom-sample-data](https://github.com/dorota-hub/DE-/assets/95073572/90c55380-645f-46df-a18b-714961df5eb6)

Designing a Star Schema for the warehouse by identifying the columns for the various dimension and fact tables in the schema using ERD Design Tool of pgAdmin to be later exported into a staging database:

<img width="788" alt="Screenshot 2023-11-27 at 17 33 34" src="https://github.com/dorota-hub/DE-/assets/95073572/6f2947db-ab18-4668-875b-cfaa1b0e10ef">

```sql
-- This script was generated by a beta version of the ERD tool in pgAdmin 4.
-- Please log an issue at https://redmine.postgresql.org/projects/pgadmin4/issues/new if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE public."softcartDimDate"
(
    dateid integer NOT NULL,
    date date,
    year integer,
    quarter integer,
    quartername "char",
    month integer,
    monthname character varying(10),
    day integer,
    weekday integer,
    weekdayname character varying(10),
    PRIMARY KEY (dateid)
);

CREATE TABLE public."softcartDimCategory"
(
    categoryid integer NOT NULL,
    categoryname character varying(20),
    PRIMARY KEY (categoryid)
);

CREATE TABLE public."softcartDimItem"
(
    itemid integer NOT NULL,
    item character varying(50),
    PRIMARY KEY (itemid)
);

CREATE TABLE public."softcartDimCountry"
(
    countryid integer NOT NULL,
    country character varying(20),
    PRIMARY KEY (countryid)
);

CREATE TABLE public."softcartFactSales"
(
    saleid integer NOT NULL,
    dateid integer NOT NULL,
    itemid integer NOT NULL,
    categoryid integer NOT NULL,
    countryid integer NOT NULL,
    PRIMARY KEY (saleid)
);

ALTER TABLE public."softcartFactSales"
    ADD FOREIGN KEY (dateid)
    REFERENCES public."softcartDimDate" (dateid)
    NOT VALID;


ALTER TABLE public."softcartFactSales"
    ADD FOREIGN KEY (itemid)
    REFERENCES public."softcartDimItem" (itemid)
    NOT VALID;


ALTER TABLE public."softcartFactSales"
    ADD FOREIGN KEY (categoryid)
    REFERENCES public."softcartDimCategory" (categoryid)
    NOT VALID;


ALTER TABLE public."softcartFactSales"
    ADD FOREIGN KEY (countryid)
    REFERENCES public."softcartDimCountry" (countryid)
    NOT VALID;

END;
```


# Create aggregation queries from a production Data Warehouse on IBM DB2

A grouping sets query:
```sql
SELECT country, category, SUM(amount) AS TOTALSALES
FROM FACTSALES 
INNER JOIN DIMCOUNTRY 
ON FACTSALES.COUNTRYID = DIMCOUNTRY.COUNTRYID
INNER JOIN DIMCATEGORY 
ON FACTSALES.CATEGORYID = DIMCATEGORY.CATEGORYID
GROUP BY GROUPING SETS(country, category)
```
A rollup query:
```sql
SELECT year, country, SUM(amount) AS TOTALSALES
FROM FACTSALES 
INNER JOIN DIMDATE 
ON FACTSALES.DATEID = DIMDATE.DATEID
INNER JOIN DIMCOUNTRY 
ON FACTSALES.COUNTRYID = DIMCOUNTRY.COUNTRYID
GROUP BY ROLLUP(year, country)
```
A cube query:
```sql
SELECT year, country, AVG(amount) AS AVERAGESALES
FROM FACTSALES 
INNER JOIN DIMDATE 
ON FACTSALES.DATEID = DIMDATE.DATEID
INNER JOIN DIMCOUNTRY 
ON FACTSALES.COUNTRYID = DIMCOUNTRY.COUNTRYID
GROUP BY CUBE(year, country)
ORDER BY year, country
```
# Create a Materialized Query Table (MQT)

```sql
CREATE TABLE total_sales_per_country (country, total_sales) AS 
	(SELECT country, SUM(amount)
FROM FACTSALES 
LEFT JOIN DIMCOUNTRY 
ON FACTSALES.COUNTRYID = DIMCOUNTRY.COUNTRYID
GROUP BY country)
	DATA INITIALLY DEFERRED 
	REFRESH DEFERRED 
	MAINTAINED BY SYSTEM;
```
